name: Deploy Angular App

on:
    push:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v5

            -   name: Setup Node.js
                uses: actions/setup-node@v6
                with:
                    node-version: '20'
                    cache: 'npm'

            -   name: Install dependencies
                run: npm ci

            -   name: Build Angular app
                run: npm run build -- --configuration production

            -   name: Add SSH private key to agent
                uses: webfactory/ssh-agent@v0.9.0
                with:
                    ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            -   name: Add server to known hosts
                run: |
                    mkdir -p ~/.ssh
                    ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

            -   name: Deploy to Server
                env:
                    SERVER_USER: ${{ secrets.SERVER_USER }}
                    SERVER_HOST: ${{ secrets.SERVER_HOST }}
                    DEPLOY_PATH: ${{ secrets.SERVER_PATH }}
                run: |

                    # Sync built files to server (excluding node_modules and source files)
                    rsync -avz --delete \
                      --exclude 'node_modules' \
                      --exclude '.git' \
                      --exclude 'src' \
                      --exclude '.angular' \
                      dist/my-website/browser/ $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/

                    echo "Deployment completed successfully!"

            -   name: Reload Nginx
                env:
                    SERVER_USER: ${{ secrets.SERVER_USER }}
                    SERVER_HOST: ${{ secrets.SERVER_HOST }}
                run: |
                    ssh $SERVER_USER@$SERVER_HOST "sudo nginx -t && sudo systemctl reload nginx"
                    echo "Nginx reloaded successfully!"

                    -   name: Verify deployment
                        env:
                            SERVER_USER: ${{ secrets.SERVER_USER }}
                            SERVER_HOST: ${{ secrets.SERVER_HOST }}
                            DEPLOY_PATH: ${{ secrets.SERVER_PATH }}
                        run: |
                            ssh $SERVER_USER@$SERVER_HOST "ls -lah $SERVER_PATH"
